<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evo Omni Publisher - Dashboard</title>
    <style>
        :root { --bg-color: #121212; --panel-bg: #1e1e1e; --border-color: #333; --text-main: #ffffff; --text-muted: #a0a0a0; --tiktok-color: #00f2fe; --success-color: #00e676; --danger-color: #ff4757; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; height: 100vh; }

        /* Sidebar and Navigation */
        .sidebar { width: 260px; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 20px; color: var(--tiktok-color); line-height: 1.4; }
        .nav-item { padding: 10px; border-radius: 5px; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .nav-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .nav-item.active { background-color: #2a2a2a; color: var(--text-main); font-weight: bold; }
        .nav-logout { color: var(--danger-color); margin-top: 10px; font-weight: bold; }
        .nav-logout:hover { background-color: rgba(255, 71, 87, 0.1); }

        /* Sidebar Footer (Legal Links) */
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 20px; font-size: 0.85rem; text-align: center; }
        .sidebar-footer a { color: var(--text-muted); text-decoration: none; display: block; margin-bottom: 8px; transition: color 0.3s; }
        .sidebar-footer a:hover { color: var(--tiktok-color); text-decoration: underline; }
        .sidebar-footer .support-email { color: #38bdf8; word-break: break-all; margin-bottom: 15px; }

        /* Main Workspace */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 30px; }
        .connected-account { background: rgba(0, 242, 254, 0.1); border: 1px solid var(--tiktok-color); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; }
        .composer-box { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 30px; max-width: 600px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }

        /* Interactive File Upload */
        .fake-upload { border: 2px dashed var(--border-color); padding: 30px; text-align: center; border-radius: 8px; color: var(--text-muted); cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        .fake-upload:hover { border-color: var(--tiktok-color); background: rgba(0, 242, 254, 0.05); }
        #file-input { display: none; }
        .file-info { color: var(--tiktok-color); font-weight: bold; margin-top: 10px; display: none; }

        /* Inputs, Selects and Toggles */
        select, input[type="datetime-local"], textarea { width: 100%; padding: 10px; background-color: #2a2a2a; color: var(--text-main); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        textarea { resize: vertical; }
        .checkbox-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .toggle-group { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 10px 15px; border-radius: 5px; margin-bottom: 20px; }

        /* Action Buttons */
        .legal-text { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 15px; }
        .publish-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #00f2fe, #4facfe); border: none; border-radius: 5px; color: #000; font-weight: bold; font-size: 1rem; cursor: pointer; transition: opacity 0.3s; }
        .publish-btn:hover { opacity: 0.9; }
        .publish-btn:disabled { background: #555; cursor: not-allowed; color: #888; }
        #success-msg { display: none; color: var(--success-color); text-align: center; margin-top: 15px; font-weight: bold; }

        /* Connections View Styles */
        .connections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; display: none; }
        .connection-card { background: #2a2a2a; border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; position: relative; }
        .connection-card.active { border-color: var(--success-color); }
        .connection-card h3 { margin: 0 0 10px 0; font-size: 1.1rem; text-transform: capitalize; }
        .connection-card .user-tag { color: var(--tiktok-color); font-weight: bold; font-size: 0.9rem; }
        .connection-card .sync-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; }
        .status-dot { width: 8px; height: 8px; background: var(--success-color); border-radius: 50%; display: inline-block; margin-right: 5px; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üöÄ Evo Omni Publisher</h2>
        <div class="nav-item" onclick="switchView(event, 'connections')">üîå Connections</div>
        <div class="nav-item active" onclick="switchView(event, 'create')">‚ú® Create Post</div>
        <div class="nav-item nav-logout" onclick="logout()">üö™ Log Out</div>

        <div class="sidebar-footer">
            <a href="/terms" target="_blank">Terms of Service</a>
            <a href="/privacy" target="_blank">Privacy Policy</a>
            <div style="margin: 15px 0 5px 0;">Support:</div>
            <a href="mailto:dev.ia.automation@gmail.com" class="support-email">dev.ia.automation@gmail.com</a>
            <p style="color: #666; margin-top: 10px;">¬© 2026 Evo Omni</p>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1 id="view-title">Create New Post</h1>
            <div class="connected-account">üü¢ Connected as: <b id="display-username">@loading...</b></div>
        </div>

        <div id="composer-view">
            <div class="composer-box">

                <div class="fake-upload" onclick="document.getElementById('file-input').click()">
                    <p id="upload-text">üìÅ Click to Browse and Select a Video</p>
                    <div id="file-details" class="file-info"></div>
                </div>
                <input type="file" id="file-input" accept="video/mp4,video/x-m4v,video/*" onchange="handleFileSelect(event)">

                <div class="form-group">
                    <label>Caption / Description</label>
                    <textarea id="post-caption" rows="4" placeholder="Write your caption here... #hashtags"></textarea>
                </div>

                <div class="form-group">
                    <label>Schedule Date & Time *</label>
                    <input type="datetime-local" id="schedule-date" required>
                </div>

                <div class="form-group">
                    <label>Privacy Level *</label>
                    <select id="privacy-select" required>
                        <option value="" disabled selected>Select Privacy Level</option>
                        <option value="PUBLIC">Public</option>
                        <option value="FRIENDS">Friends</option>
                        <option value="SELF_ONLY">Private (Only Me)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Allow Interactions</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox"> Comments</label>
                        <label class="checkbox-item"><input type="checkbox"> Duet</label>
                        <label class="checkbox-item"><input type="checkbox"> Stitch</label>
                    </div>
                </div>

                <div class="toggle-group">
                    <span>Commercial Content Disclosure</span>
                    <input type="checkbox" id="commercial-toggle">
                </div>

                <p class="legal-text">By posting, you agree to TikTok's Music Usage Confirmation</p>

                <button class="publish-btn" id="publish-btn" onclick="submitRealPost()">Schedule on TikTok</button>
                <div id="success-msg">‚úÖ Success! Video scheduled and queued for publishing.</div>
            </div>
        </div>

        <div id="connections-view" class="connections-grid">
        </div>
    </div>

    <script>
        function logout() {
            // 1. Confirm with the user before destroying the session
            const confirmLogout = confirm("Are you sure you want to log out and end your session?");

            if (confirmLogout) {
                console.log("üö™ Logging out: Clearing session and redirecting...");

                // 2. Clear client-side persistence
                localStorage.clear();
                sessionStorage.clear();

                // 3. Clear cookies (Optional but recommended for robust logout)
                document.cookie.split(";").forEach((c) => {
                    document.cookie = c
                        .replace(/^ +/, "")
                        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });

                // 4. Redirect to the main login/connection page
                window.location.href = '/';
            } else {
                // User clicked 'Cancel', do nothing and stay on the dashboard
                console.log("‚úÖ Logout cancelled by user.");
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const mbSize = (file.size / (1024 * 1024)).toFixed(2);
                document.getElementById('upload-text').innerText = "‚úÖ Video Ready";
                const details = document.getElementById('file-details');
                details.innerText = `${file.name} (${mbSize} MB)`;
                details.style.display = 'block';
            }
        }

        async function submitRealPost() {
            const fileInput = document.getElementById('file-input');
            const privacy = document.getElementById('privacy-select').value;
            const caption = document.getElementById('post-caption').value;
            const scheduledTime = document.getElementById('schedule-date').value;

            if (!fileInput.files[0]) { alert("Please select a video file."); return; }
            if (!privacy) { alert("Please select a Privacy Level."); return; }
            if (!scheduledTime) { alert("Please select a schedule date & time."); return; }

            const proceed = confirm(
                "‚ö†Ô∏è DEMONSTRATION MODE ACTIVE\n\n" +
                "For audit and demonstration purposes, this post will be executed IMMEDIATELY, overriding your selected schedule time.\n\n" +
                "Do you want to proceed with the immediate publication?"
            );

            if (!proceed) return;

            const btn = document.getElementById('publish-btn');
            const msg = document.getElementById('success-msg');

            btn.innerText = "Uploading to Server...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("privacy", privacy);
            formData.append("caption", caption);

            try {
                const response = await fetch('/api/v1/publish/web-direct', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get("content-type");
                if (response.ok) {
                    btn.style.display = 'none';
                    msg.style.display = 'block';
                    msg.innerText = "‚úÖ Success! Video published to TikTok.";
                } else if (contentType && contentType.includes("application/json")) {
                    const error = await response.json();
                    alert("Error publishing: " + (error.detail || "Unknown error"));
                    btn.innerText = "Try Again";
                    btn.disabled = false;
                } else {
                    alert(`Server Error ${response.status}: Ensure Nginx allows large file uploads and the endpoint exists.`);
                    btn.innerText = "Try Again";
                    btn.disabled = false;
                }
            } catch (err) {
                alert("Network error: " + err.message);
                btn.innerText = "Try Again";
                btn.disabled = false;
            }
        }

        // Function to load dynamic profile data
        async function fetchAccountData() {
            try {
                // We assume client_id 1 for now, as in your routes
                const response = await fetch('/api/v1/oauth/user/profile/1');
                const data = await response.json();
                const profiles = data.profiles || {};

                // 1. Update the Header (Connected as: @name)
                const userDisplay = document.querySelector('.connected-account b');
                if (profiles.tiktok && profiles.tiktok.connected) {
                    userDisplay.innerText = `@${profiles.tiktok.username}`;
                } else {
                    userDisplay.innerText = "No account linked";
                    document.querySelector('.connected-account').style.borderColor = "var(--danger-color)";
                }

                // 2. Update the "Connections" sidebar item (Optional enhancement)
                const connectionsNav = document.querySelector('.nav-item:nth-child(2)');
                if (profiles.tiktok) {
                    connectionsNav.innerHTML = `üîå Connections <span style="font-size:0.7rem; color:var(--success-color)">(1 Active)</span>`;
                }
            } catch (err) {
                console.error("Failed to load profile data:", err);
            }
        }

        // Function to update UI with real account data
        async function updateUIWithProfile() {
            try {
                // We call the endpoint for client 1 (as established in your routes)
                const response = await fetch('/api/v1/oauth/user/profile/1');
                const data = await response.json();
                const profiles = data.profiles || {};

                // 1. UPDATE HEADER USERNAME
                const usernameB = document.getElementById('display-username');
                if (profiles.tiktok && profiles.tiktok.connected) {
                    usernameB.innerText = `@${profiles.tiktok.username}`;
                } else {
                    usernameB.innerText = "No account linked";
                    usernameB.parentElement.style.borderColor = "var(--danger-color)";
                }

                // 2. UPDATE "CONNECTIONS" SIDEBAR ITEM
                const connectionsItem = document.querySelector('.nav-item:nth-child(2)');
                const activeCount = Object.keys(profiles).length;
                if (activeCount > 0) {
                    connectionsItem.innerHTML = `üîå Connections <span style="font-size:0.75rem; color:var(--success-color)">(${activeCount} Active)</span>`;
                }

            } catch (err) {
                console.error("‚ùå Error fetching profile:", err);
            }
        }

        // Function to switch between views
        // 1. Switch between Post Creator and Connections Grid
        async function switchView(event, view) {
            const composerView = document.getElementById('composer-view');
            const connectionsView = document.getElementById('connections-view');
            const title = document.getElementById('view-title');

            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (view === 'create') {
                composerView.style.display = 'block';
                connectionsView.style.display = 'none';
                title.innerText = "Create New Post";
            } else {
                composerView.style.display = 'none';
                connectionsView.style.display = 'grid'; // Force grid display
                title.innerText = "Managed Connections";
                await loadConnectionsList(); // Refresh data when opening
            }
        }

        // Function to fetch and render connections
        // 2. Fetch and render account cards
        async function loadConnectionsList() {
            const container = document.getElementById('connections-view');
            container.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>üîÑ Loading accounts...</p>";

            try {
                const response = await fetch('/api/v1/oauth/user/profile/1');
                const data = await response.json();
                const profiles = data.profiles || {};

                container.innerHTML = ""; // Clear loader

                const platforms = [
                    { id: 'tiktok', color: '#00f2fe', icon: 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png' },
                    { id: 'youtube', color: '#FF0000', icon: 'https://cdn-icons-png.flaticon.com/512/1384/1384060.png' },
                    { id: 'instagram', color: '#E1306C', icon: 'https://cdn-icons-png.flaticon.com/512/174/174855.png' }
                ];

                platforms.forEach(p => {
                    const info = profiles[p.id];
                    const card = document.createElement('div');
                    card.className = `connection-card ${info ? 'active' : ''}`;
                    card.style.borderLeft = `4px solid ${info ? p.color : '#444'}`;

                    card.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                            <img src="${p.icon}" style="width:24px; height:24px;">
                            <h3 style="margin:0; text-transform:capitalize;">${p.id}</h3>
                        </div>
                        ${info
                            ? `<div class="user-tag">@${info.username}</div>
                               <div class="sync-date"><span class="status-dot"></span> Active since: ${info.last_sync || 'Just Now'}</div>
                               <button onclick="window.location.href='/api/v1/oauth/login/${p.id}/1'" style="margin-top:15px; background:transparent; border:1px solid #555; color:#aaa; font-size:0.7rem; padding:5px 10px; cursor:pointer;">Reconnect</button>`
                            : `<div style="color:#666; font-size:0.9rem; margin-bottom:15px;">No account linked</div>
                               <button class="publish-btn" onclick="window.location.href='/api/v1/oauth/login/${p.id}/1'" style="padding:8px; font-size:0.8rem;">Connect ${p.id}</button>`
                        }
                    `;
                    container.appendChild(card);
                });

                // Sync Header Username
                const headerName = document.getElementById('display-username');
                if (profiles.tiktok && headerName) {
                    headerName.innerText = `@${profiles.tiktok.username}`;
                }

                // Sync Sidebar Badge
                const connNav = document.querySelector('.nav-item:nth-child(1)');
                const activeCount = Object.keys(profiles).length;
                if (connNav) connNav.innerHTML = `üîå Connections <span style="font-size:0.7rem; color:var(--success-color)">(${activeCount} Active)</span>`;

            } catch (err) {
                console.error("Dashboard Load Error:", err);
            }
        }

        // Update window.onload to include profile fetching
        window.onload = function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('schedule-date').value = now.toISOString().slice(0,16);

            // FETCH DYNAMIC DATA
            loadConnectionsList();
        };
    </script>
</body>
</html>